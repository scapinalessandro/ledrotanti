#include <SPI.h>

#define MOSI D10
#define SCLK D8
#define RCLK D9
#define BUFFER_1 D0
#define BUFFER_2 D6
#define BUFFER_3 D4
#define BUFFER_4 D2
#define TRG_1 D1
#define TRG_2 D5
#define TRG_3 D3
#define TRG_4 D7

int freq = 5000;

long del = 1;

const uint8_t zero[] = {0,0,0,0,0};

const int angleCoeff = 1; // una striscia di immagine ogni 5 gradi. per essere cambiata deve cambiare anche image
int position = 0;         // le posizioni massime sono date da angleCoeff. in questo caso positions non puo superare 72 (71 visto che Ã¨ un indice) (360/5)

SPISettings settings(20000000, MSBFIRST, SPI_MODE0);

uint32_t prevTime = 0;
uint32_t delta = 0;

uint8_t image[360][5] = 
{
{0x3,0xf8,0x81,0xff,0xff},
{0x3,0xff,0x83,0xff,0xff},
{0x3,0xff,0xc3,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0x8f,0xff,0xff},
{0x3,0xfc,0x7,0xff,0xff},
{0x3,0xf8,0x3,0xff,0xff},
{0x3,0xf8,0x3,0xff,0xff},
{0x3,0xf0,0x1,0xff,0xff},
{0x3,0xf1,0xf1,0xff,0xff},
{0x3,0xe3,0xf1,0xff,0xff},
{0x3,0xe3,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe3,0xf9,0xff,0xff},
{0x3,0xe3,0xf9,0xff,0xff},
{0x3,0xf0,0xe1,0xff,0xff},
{0x3,0xf0,0x1,0xff,0xff},
{0x3,0xf0,0x3,0xff,0xff},
{0x3,0xf8,0x3,0xff,0xff},
{0x3,0xfc,0x7,0xff,0xff},
{0x3,0xff,0xf,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xe7,0xff,0xff,0xff},
{0x3,0xe7,0xff,0xff,0xff},
{0x3,0xe7,0xff,0xff,0xff},
{0x3,0xe3,0xff,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe2,0x21,0xff,0xff},
{0x3,0xe3,0xff,0xff,0xff},
{0x3,0xe7,0xff,0xff,0xff},
{0x3,0xe7,0xff,0xff,0xff},
{0x3,0xe7,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xf9,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xff,0xe1,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0x8f,0xff,0xff},
{0x3,0xfe,0x3,0xff,0xff},
{0x3,0xfc,0x3,0xff,0xff},
{0x3,0xf8,0x3,0xff,0xff},
{0x3,0xf0,0x1,0xff,0xff},
{0x3,0xf0,0xf1,0xff,0xff},
{0x3,0xf3,0xf9,0xff,0xff},
{0x3,0xe3,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe3,0xf8,0xff,0xff},
{0x3,0xe3,0xf9,0xff,0xff},
{0x3,0xe3,0xf9,0xff,0xff},
{0x3,0xf7,0xf9,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xf9,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xe1,0xff,0xff},
{0x3,0xff,0xc1,0xff,0xff},
{0x3,0xff,0x81,0xff,0xff},
{0x3,0xff,0x3,0xff,0xff},
{0x3,0xfc,0x7,0xff,0xff},
{0x3,0xf8,0xf,0xff,0xff},
{0x3,0xe0,0x7,0xff,0xff},
{0x3,0xe0,0xc7,0xff,0xff},
{0x3,0xe3,0xcf,0xff,0xff},
{0x3,0xe1,0xc7,0xff,0xff},
{0x3,0xe0,0x4f,0xff,0xff},
{0x3,0xf0,0xf,0xff,0xff},
{0x3,0xfc,0xf,0xff,0xff},
{0x3,0xfe,0x3,0xff,0xff},
{0x3,0xff,0x81,0xff,0xff},
{0x3,0xff,0xc1,0xff,0xff},
{0x3,0xff,0xe1,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xfd,0xff,0xff},
{0x3,0xff,0xfd,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xa1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe3,0x1f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xfc,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe3,0x39,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xff,0xb9,0xff,0xff},
{0x3,0xff,0xf9,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xf8,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe3,0xf,0xff,0xff},
{0x3,0xe0,0x7,0xff,0xff},
{0x3,0xf0,0x7,0xff,0xff},
{0x3,0xf0,0x63,0xff,0xff},
{0x3,0xf8,0x61,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xfb,0xff,0xff},
{0x3,0xff,0xf9,0xff,0xff},
{0x3,0xff,0xf9,0xff,0xff},
{0x3,0xff,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x5,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe7,0xf,0xff,0xff},
{0x3,0xe2,0xf,0xff,0xff},
{0x3,0xf0,0x3,0xff,0xff},
{0x3,0xf0,0x3,0xff,0xff},
{0x3,0xf0,0x61,0xff,0xff},
{0x3,0xf8,0xe1,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xfb,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xe1,0xff,0xff},
{0x3,0xff,0xc1,0xff,0xff},
{0x3,0xff,0x81,0xff,0xff},
{0x3,0xff,0x3,0xff,0xff},
{0x3,0xfc,0x7,0xff,0xff},
{0x3,0xf8,0xf,0xff,0xff},
{0x3,0xe0,0xf,0xff,0xff},
{0x3,0xe0,0xcf,0xff,0xff},
{0x3,0xe3,0xcf,0xff,0xff},
{0x3,0xe3,0xcf,0xff,0xff},
{0x3,0xe0,0xcf,0xff,0xff},
{0x3,0xe0,0xf,0xff,0xff},
{0x3,0xf8,0xf,0xff,0xff},
{0x3,0xfc,0x7,0xff,0xff},
{0x3,0xfe,0x3,0xff,0xff},
{0x3,0xff,0x81,0xff,0xff},
{0x3,0xff,0xc3,0xff,0xff},
{0x3,0xff,0xe3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xf9,0xff,0xff},
{0x3,0xff,0xfb,0xff,0xff},
{0x3,0xff,0xc3,0xff,0xff},
{0x3,0xe0,0x3,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe2,0xf,0xff,0xff},
{0x3,0xe0,0x7,0xff,0xff},
{0x3,0xe0,0x43,0xff,0xff},
{0x3,0xf0,0x63,0xff,0xff},
{0x3,0xf8,0xe1,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xfb,0xff,0xff},
{0x3,0xff,0xfb,0xff,0xff},
{0x3,0xff,0xf7,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xff,0xe1,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xe3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xf0,0xf1,0xff,0xff},
{0x3,0xe0,0x71,0xff,0xff},
{0x3,0xe0,0x79,0xff,0xff},
{0x3,0xe0,0x71,0xff,0xff},
{0x3,0xc6,0x31,0xff,0xff},
{0x3,0xc6,0x31,0xff,0xff},
{0x3,0xe6,0x31,0xff,0xff},
{0x3,0xe7,0x11,0xff,0xff},
{0x3,0xe7,0x3,0xff,0xff},
{0x3,0xe7,0x3,0xff,0xff},
{0x3,0xef,0x83,0xff,0xff},
{0x3,0xff,0x87,0xff,0xff},
{0x3,0xff,0xef,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xef,0xe3,0xff,0xff},
{0x3,0xe3,0xe1,0xff,0xff},
{0x3,0xe3,0xe1,0xff,0xff},
{0x3,0xe7,0xc3,0xff,0xff},
{0x3,0xe7,0x83,0xff,0xff},
{0x3,0xc7,0x83,0xff,0xff},
{0x3,0xe7,0x19,0xff,0xff},
{0x3,0xc6,0x11,0xff,0xff},
{0x3,0xe0,0x31,0xff,0xff},
{0x3,0xe0,0x31,0xff,0xff},
{0x3,0xf0,0x73,0xff,0xff},
{0x3,0xf0,0xf3,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0x3,0xff,0xff},
{0x3,0xc0,0x3,0xff,0xff},
{0x3,0xc0,0x3,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe4,0x3f,0xff,0xff},
{0x3,0xfe,0x3f,0xff,0xff},
{0x3,0xfc,0x3f,0xff,0xff},
{0x3,0xfc,0x1f,0xff,0xff},
{0x3,0xf8,0xf,0xff,0xff},
{0x3,0xf0,0x7,0xff,0xff},
{0x3,0xe1,0x87,0xff,0xff},
{0x3,0xe3,0xc3,0xff,0xff},
{0x3,0xc7,0xe1,0xff,0xff},
{0x3,0xcf,0xe3,0xff,0xff},
{0x3,0xdf,0xf3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xe3,0xe3,0xff,0xff},
{0x3,0xe3,0xc3,0xff,0xff},
{0x3,0xe7,0xc3,0xff,0xff},
{0x3,0xe7,0xc1,0xff,0xff},
{0x3,0xc7,0x83,0xff,0xff},
{0x3,0xc7,0x83,0xff,0xff},
{0x3,0xc7,0x11,0xff,0xff},
{0x3,0xe6,0x11,0xff,0xff},
{0x3,0xe0,0x31,0xff,0xff},
{0x3,0xe0,0x71,0xff,0xff},
{0x3,0xf0,0xf1,0xff,0xff},
{0x3,0xf8,0xf3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xff,0x73,0xff,0xff},
{0x3,0xf0,0x71,0xff,0xff},
{0x3,0xe0,0x79,0xff,0xff},
{0x3,0xe0,0x79,0xff,0xff},
{0x3,0xe0,0x79,0xff,0xff},
{0x3,0xe6,0x79,0xff,0xff},
{0x3,0xe6,0x79,0xff,0xff},
{0x3,0xe6,0x71,0xff,0xff},
{0x3,0xe6,0x31,0xff,0xff},
{0x3,0xe6,0x3,0xff,0xff},
{0x3,0xe7,0x3,0xff,0xff},
{0x3,0xf7,0x3,0xff,0xff},
{0x3,0xff,0x7,0xff,0xff},
{0x3,0xff,0xc7,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xf3,0xff,0xff},
{0x3,0xfe,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe1,0x3f,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x3f,0xff,0xff},
{0x3,0xe7,0x1f,0xff,0xff},
{0x3,0xe3,0xf,0xff,0xff},
{0x3,0xe0,0x7,0xff,0xff},
{0x3,0xe0,0x7,0xff,0xff},
{0x3,0xf0,0x43,0xff,0xff},
{0x3,0xf0,0x61,0xff,0xff},
{0x3,0xfd,0xf1,0xff,0xff},
{0x3,0xff,0xf1,0xff,0xff},
{0x3,0xff,0xfb,0xff,0xff},
{0x3,0xff,0xfb,0xff,0xff},
{0x3,0xff,0x8f,0xff,0xff},
{0x3,0xfe,0x7,0xff,0xff},
{0x3,0xf8,0x3,0xff,0xff},
{0x3,0xf0,0x3,0xff,0xff},
{0x3,0xf0,0x3,0xff,0xff},
{0x3,0xf1,0xf1,0xff,0xff},
{0x3,0xe3,0xf1,0xff,0xff},
{0x3,0xe3,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe7,0xf9,0xff,0xff},
{0x3,0xe3,0xf1,0xff,0xff},
{0x3,0xe1,0xf1,0xff,0xff},
{0x3,0xf0,0x1,0xff,0xff},
{0x3,0xf0,0x3,0xff,0xff},
{0x3,0xf8,0x3,0xff,0xff},
{0x3,0xfc,0x7,0xff,0xff},
{0x3,0xff,0x8f,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xff,0xff,0xff},
{0x3,0xff,0xf9,0xff,0xff},
{0x3,0xff,0x81,0xff,0xff},
{0x3,0xfc,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe0,0x1,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe7,0x39,0xff,0xff},
{0x3,0xe2,0x39,0xff,0xff},
{0x3,0xf0,0x1,0xff,0xff},
{0x3,0xf0,0x81,0xff,0xff},
{0x3,0xf0,0x83,0xff,0xff},
};

bool state = false;

void IRAM_ATTR onTimer()
{
  writeImg(position);
  
  digitalWrite(RCLK, HIGH);
  digitalWrite(RCLK, LOW);

  position++;

  if(position >= 360) position = 0;
}

void setup() {
  SPI.begin(SCLK, -1, MOSI);
  Serial.begin(9600);
  pinMode(TRG_2, INPUT);
  pinMode(BUFFER_1, OUTPUT);
  pinMode(BUFFER_2, OUTPUT);
  pinMode(BUFFER_3, OUTPUT);
  pinMode(BUFFER_4, OUTPUT);
  pinMode(RCLK, OUTPUT);
  SPI.beginTransaction(settings);

  timer = timerBegin(0, 160, true); // la cpu va a 160MHz quindi un prescaler da 160 ci da tick da 1us
  timerAttachInterrupt(timer, &onTimer, true);

  timerAlarmWrite(timer, 110, true);    
  timerAlarmEnable(timer);             // attiva il timer
}

void loop() 
{
  bool button2state = digitalRead(TRG_2);
  if(button2state && state == LOW)
  {
    state = false;
    uint32_t currentTime = micros();
    delta = currentTime - prevTime;
    prevTime = currentTime;
    timerAlarmWrite(timer, int(delta/360), true);
  }
  state = button2state;
}

void writeImg(uint8_t pos)
{
  digitalWrite(BUFFER_1, LOW);
  digitalWrite(BUFFER_2, HIGH);
  digitalWrite(BUFFER_3, HIGH);
  digitalWrite(BUFFER_4, HIGH);
  SPI.writeBytes(image[pos],5);
  digitalWrite(BUFFER_1, HIGH);
  digitalWrite(BUFFER_2, LOW);
  digitalWrite(BUFFER_3, HIGH);
  digitalWrite(BUFFER_4, HIGH);
  SPI.writeBytes(image[getPosFromAngle(1,pos)],5);
  digitalWrite(BUFFER_1, HIGH);
  digitalWrite(BUFFER_2, HIGH);
  digitalWrite(BUFFER_3, LOW);
  digitalWrite(BUFFER_4, HIGH);
  SPI.writeBytes(image[getPosFromAngle(2,pos)],5);
  digitalWrite(BUFFER_1, HIGH);
  digitalWrite(BUFFER_2, HIGH);
  digitalWrite(BUFFER_3, HIGH);
  digitalWrite(BUFFER_4, LOW);
  SPI.writeBytes(image[getPosFromAngle(3,pos)],5);
}

uint8_t getPosFromAngle(uint8_t angle, uint8_t pos)   // l'angolo deve essere 1,2,3 che sono rispettivamente 90, 180, 270 gradi
{
  uint8_t val = (90*angle)+pos; // int(90 / angleCoeff) * angle + pos;
  if(val >= 360) val = val - 360;
  return val;
}
